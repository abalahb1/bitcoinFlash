generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                @id @default(cuid())
  name                String
  username            String                @unique
  email               String?               @unique
  phone               String?
  password            String
  wallet_balance_usdt Float                 @default(0.00)
  wallet_balance_btc  Float                 @default(0.00)
  wallet_ref          String?
  usdt_trc20_address  String?
  btc_wallet_address  String?               // Bitcoin wallet address for receiving Flash BTC
  kyc_passport_url    String?
  kyc_selfie_url      String?
  kyc_status          String                @default("none")
  is_verified         Boolean               @default(false)
  commission_wallet   String?
  account_tier        String                @default("bronze")
  
  // Security & 2FA fields
  two_fa_enabled      Boolean               @default(false)
  anti_phishing_code  String?
  session_timeout_mins Int                  @default(30)
  last_activity_at    DateTime              @default(now())
  
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deposits            DepositNotification[]
  payments            Payment[]
  withdrawalRequests  WithdrawalRequest[]
  securityEvents      SecurityEvent[]
}

model Package {
  id          String    @id @default(cuid())
  name        String
  usdt_amount String
  btc_amount  String
  price_usd   Float
  duration    Int       @default(45)
  transfers   Int       @default(27)
  locked      Boolean   @default(false)
  payments    Payment[]
}

model Payment {
  id           String   @id @default(uuid())
  user_id      String
  package_id   String
  amount       Float
  buyer_wallet String
  network_type String   @default("BTC")
  status       String   @default("pending")
  commission   Float    @default(0.0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  package      Package  @relation(fields: [package_id], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model WithdrawalRequest {
  id               String    @id @default(uuid())
  user_id          String
  amount           Float
  address          String
  network          String    @default("TRC20")
  status           String    @default("pending")
  rejection_reason String?
  admin_notes      String?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  processed_at     DateTime?
  user             User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
}

model DepositNotification {
  id           String    @id @default(uuid())
  user_id      String
  amount       Float
  tx_hash      String?
  status       String    @default("pending")
  confirmed_by String?
  admin_notes  String?
  created_at   DateTime  @default(now())
  confirmed_at DateTime?
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
}

model SecurityEvent {
  id          String   @id @default(uuid())
  user_id     String
  event_type  String   // "login", "logout", "withdrawal", "2fa_sent", "password_change", etc.
  ip_address  String?
  device_info String?
  location    String?
  metadata    String?  // JSON string for additional data
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([created_at])
}
